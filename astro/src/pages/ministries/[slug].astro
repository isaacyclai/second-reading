---
import Layout from "../../layouts/Layout.astro";
import SectionLabel from "../../components/SectionLabel.astro";
import QuestionCard from "../../components/QuestionCard.astro";
import BillCard from "../../components/BillCard.astro";
import Pagination from "../../components/Pagination.astro";
import Tag from "../../components/Tag.astro";
import {
  getAllMinistries,
  getMinistry,
  getMinistrySections,
  getMinistryBills,
} from "../../lib/db";
import { slugify } from "../../lib/slugify";

export async function getStaticPaths() {
  const ministries = getAllMinistries();
  return ministries.map((ministry) => ({
    params: { slug: slugify(ministry.name, ministry.id) },
    props: { id: ministry.id },
  }));
}

const { id } = Astro.props;
const ministry = getMinistry(id);

if (!ministry) {
  return Astro.redirect("/ministries");
}

const sections = getMinistrySections(id);
const bills = getMinistryBills(id);

// Categorize sections
const questions = sections.filter((s) =>
  ["OA", "WA", "WANA"].includes(s.sectionType),
);
const motions = sections.filter(
  (s) => s.category === "motion" || s.category === "adjournment_motion",
);
const clarifications = sections.filter((s) => s.category === "clarification");
---

<Layout
  title={ministry.name}
  description={`Parliamentary activities for ${ministry.name}`}
>
  <a
    href="/ministries"
    class="inline-flex items-center font-sans text-sm text-accent hover:text-accent-light no-underline mb-8"
  >
    ‚Üê Back to Ministries
  </a>

  <header class="mb-10">
    <div class="flex items-center gap-3 mb-3">
      <Tag color="green" class="text-sm px-0 py-1">{ministry.acronym}</Tag>
    </div>
    <h1 class="font-display text-display-md text-ink mb-2">
      {ministry.name}
    </h1>
    <p class="font-sans text-sm text-ink-muted">
      {ministry.sectionCount} total sections
    </p>
  </header>

  <!-- Unified search across all sections -->
  <div class="mb-8" data-pagefind-ignore data-ministry-name={ministry.name}>
    <div class="relative">
      <svg
        class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-ink/40 pointer-events-none"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        type="text"
        id="ministry-search-input"
        class="w-full rounded-lg border border-border bg-surface px-4 py-2.5 pl-10 pr-10 font-ui text-sm text-ink placeholder:text-ink/40 focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent/20 transition-colors"
        placeholder="Search this ministry's parliamentary activity..."
        autocomplete="off"
        spellcheck="false"
      />
      <button
        type="button"
        id="ministry-search-clear"
        class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-ink/40 hover:text-ink transition-colors hidden"
        aria-label="Clear search"
      >
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <p
      id="ministry-search-status"
      class="mt-2 font-sans text-sm text-ink-muted hidden"
    >
    </p>
  </div>

  <!-- Bills -->
  {
    bills.length > 0 && (
      <section class="mb-10">
        <h2 class="font-display text-xl text-ink mb-4">
          Bills{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({bills.length})
          </span>
        </h2>
        <div id="bills-list" class="flex flex-col border-t border-border">
          {bills.map((bill) => (
            <div class="bill-item">
              <div class="hidden" data-pagefind-body>
                <span data-pagefind-meta={`id:${bill.id}`} />
                <span data-pagefind-filter={`ministry:${ministry.name}`} />
              </div>
              <BillCard bill={bill} />
            </div>
          ))}
        </div>
        <Pagination
          containerId="bills-list"
          itemSelector=".bill-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  <!-- Motions -->
  {
    motions.length > 0 && (
      <section class="mb-10">
        <h2 class="font-display text-xl text-ink mb-4">
          Motions{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({motions.length})
          </span>
        </h2>
        <div id="motions-list" class="flex flex-col border-t border-border">
          {motions.map((section) => (
            <div class="motion-item">
              <div class="hidden" data-pagefind-body>
                <span data-pagefind-meta={`id:${section.id}`} />
                <span data-pagefind-filter={`ministry:${ministry.name}`} />
              </div>
              <QuestionCard section={section} />
            </div>
          ))}
        </div>
        <Pagination
          containerId="motions-list"
          itemSelector=".motion-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  <!-- Clarifications -->
  {
    clarifications.length > 0 && (
      <section class="mb-10">
        <h2 class="font-display text-xl text-ink mb-4">
          Clarifications{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({clarifications.length})
          </span>
        </h2>
        <div
          id="clarifications-list"
          class="flex flex-col border-t border-border"
        >
          {clarifications.map((section) => (
            <div class="clarification-item">
              <div class="hidden" data-pagefind-body>
                <span data-pagefind-meta={`id:${section.id}`} />
                <span data-pagefind-filter={`ministry:${ministry.name}`} />
              </div>
              <QuestionCard section={section} />
            </div>
          ))}
        </div>
        <Pagination
          containerId="clarifications-list"
          itemSelector=".clarification-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  <!-- Questions -->
  {
    questions.length > 0 && (
      <section class="mb-10">
        <h2 class="font-display text-xl text-ink mb-4">
          Questions{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({questions.length})
          </span>
        </h2>
        <div id="questions-list" class="flex flex-col border-t border-border">
          {questions.map((section) => (
            <div class="question-item">
              <div class="hidden" data-pagefind-body>
                <span data-pagefind-meta={`id:${section.id}`} />
                <span data-pagefind-filter={`ministry:${ministry.name}`} />
              </div>
              <QuestionCard section={section} />
            </div>
          ))}
        </div>
        <Pagination
          containerId="questions-list"
          itemSelector=".question-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  {
    sections.length === 0 && bills.length === 0 && (
      <p class="py-12 text-center font-body text-ink-muted">
        No parliamentary activities found for this ministry.
      </p>
    )
  }

  <script>
    interface PagefindResult {
      id: string;
      data: () => Promise<{
        meta?: { id?: string };
        url: string;
        excerpt: string;
      }>;
    }

    interface PagefindSearch {
      results: PagefindResult[];
    }

    interface Pagefind {
      search: (
        query: string,
        options?: { filters?: Record<string, string> },
      ) => Promise<PagefindSearch>;
    }

    let pagefind: Pagefind | null = null;

    async function loadPagefind(): Promise<Pagefind | null> {
      if (pagefind) return pagefind;
      try {
        const base = import.meta.env.BASE_URL || "/";
        const pagefindPath = `${base}pagefind/pagefind.js`.replace(/\/+/g, "/");
        pagefind = (await import(/* @vite-ignore */ pagefindPath)) as Pagefind;
        return pagefind;
      } catch {
        return null;
      }
    }

    function initMinistrySearch() {
      const wrapper = document.querySelector(
        "[data-ministry-name]",
      ) as HTMLElement;
      if (!wrapper) return;
      const ministryName = wrapper.getAttribute("data-ministry-name")!;

      const input = document.getElementById(
        "ministry-search-input",
      ) as HTMLInputElement;
      const clearBtn = document.getElementById(
        "ministry-search-clear",
      ) as HTMLButtonElement;
      const status = document.getElementById(
        "ministry-search-status",
      ) as HTMLElement;
      if (!input) return;
      if (input.hasAttribute("data-search-initialized")) return;
      input.setAttribute("data-search-initialized", "true");

      const sectionConfigs = [
        { id: "bills-list", selector: ".bill-item" },
        { id: "motions-list", selector: ".motion-item" },
        { id: "clarifications-list", selector: ".clarification-item" },
        { id: "questions-list", selector: ".question-item" },
      ]
        .map((s) => {
          const container = document.getElementById(s.id);
          if (!container) return null;
          const sectionEl = container.closest("section");
          const items = Array.from(
            container.querySelectorAll(s.selector),
          ) as HTMLElement[];
          return { container, sectionEl, items };
        })
        .filter(Boolean) as {
        container: HTMLElement;
        sectionEl: Element | null;
        items: HTMLElement[];
      }[];

      function getItemId(item: HTMLElement): string | null {
        return (
          item.getAttribute("data-search-id") ||
          item
            .querySelector("[data-search-id]")
            ?.getAttribute("data-search-id") ||
          null
        );
      }

      let debounceTimer: ReturnType<typeof setTimeout>;
      let searchSeq = 0;

      function updateSections(
        matchingIds: Set<string> | null,
        lowerQuery: string,
      ) {
        let totalMatches = 0;
        for (const sec of sectionConfigs) {
          let sectionMatches = 0;
          for (const item of sec.items) {
            let isMatch: boolean;
            if (matchingIds !== null) {
              const id = getItemId(item);
              isMatch = id !== null && matchingIds.has(id);
            } else {
              const text = item.textContent?.toLowerCase() || "";
              isMatch = text.includes(lowerQuery);
            }
            if (isMatch) {
              item.style.display = "";
              item.removeAttribute("data-search-hidden");
              sectionMatches++;
            } else {
              item.style.display = "none";
              item.setAttribute("data-search-hidden", "true");
            }
          }
          if (sec.sectionEl) {
            (sec.sectionEl as HTMLElement).style.display =
              sectionMatches === 0 ? "none" : "";
          }
          totalMatches += sectionMatches;
          sec.container.dispatchEvent(
            new CustomEvent("search-updated", {
              detail: { matchCount: sectionMatches, reordered: false },
            }),
          );
        }
        status.textContent = `Found ${totalMatches} result${totalMatches !== 1 ? "s" : ""}`;
        status.classList.remove("hidden");
      }

      async function performSearch(query: string) {
        const seq = ++searchSeq;
        const lowerQuery = query.toLowerCase().trim();

        if (!lowerQuery) {
          for (const sec of sectionConfigs) {
            if (sec.sectionEl)
              (sec.sectionEl as HTMLElement).style.display = "";
            for (const item of sec.items) {
              item.style.display = "";
              item.removeAttribute("data-search-hidden");
            }
            sec.container.dispatchEvent(
              new CustomEvent("search-cleared", {
                detail: { reordered: false },
              }),
            );
          }
          status.classList.add("hidden");
          clearBtn.classList.add("hidden");
          return;
        }

        clearBtn.classList.remove("hidden");

        const pf = await loadPagefind();
        if (seq !== searchSeq) return;

        if (pf) {
          const results = await pf.search(query, {
            filters: { ministry: ministryName },
          });
          if (seq !== searchSeq) return;

          // Fetch all fragments in parallel
          const allFragments = await Promise.all(
            results.results.map((r) => r.data()),
          );
          if (seq !== searchSeq) return;

          const orderedIds: string[] = [];
          for (const data of allFragments) {
            if (data.meta?.id) {
              orderedIds.push(data.meta.id);
            }
          }
          const matchingIds = new Set<string>(orderedIds);

          updateSections(matchingIds, lowerQuery);
          return;
        }

        // Fallback: text matching
        updateSections(null, lowerQuery);
      }

      input.addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => performSearch(input.value), 100);
      });

      clearBtn.addEventListener("click", () => {
        input.value = "";
        performSearch("");
        input.focus();
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && input.value) {
          input.value = "";
          performSearch("");
        }
      });

      input.addEventListener(
        "focus",
        () => {
          loadPagefind();
        },
        { once: true },
      );
    }

    initMinistrySearch();
    document.addEventListener("astro:after-swap", initMinistrySearch);
  </script>
</Layout>
