---
import Layout from "../../layouts/Layout.astro";
import SectionLabel from "../../components/SectionLabel.astro";
import AISummaryCard from "../../components/AISummaryCard.astro";
import QuestionCard from "../../components/QuestionCard.astro";
import Pagination from "../../components/Pagination.astro";

import Avatar from "../../components/Avatar.astro";
import Tag from "../../components/Tag.astro";
import AttendanceDotGrid from "../../components/AttendanceDotGrid.astro";
import {
  getAllMembersWithInfo,
  getMember,
  getMemberSections,
  getMemberAttendance,
  getMemberCurrentParliamentStats,
  getLatestParliament,
} from "../../lib/db";
import { slugify } from "../../lib/slugify";

export async function getStaticPaths() {
  const members = getAllMembersWithInfo();
  return members.map((member) => ({
    params: { slug: slugify(member.name, member.id) },
    props: { id: member.id },
  }));
}

const { id } = Astro.props;
const member = getMember(id);

if (!member) {
  return Astro.redirect("/members");
}

const sections = getMemberSections(id);
const attendance = getMemberAttendance(id);
const currentParlStats = getMemberCurrentParliamentStats(id);
const latestParliament = getLatestParliament();

// Categorize sections
const motions = sections.filter(
  (s) =>
    s.category === "motion" ||
    s.category === "adjournment_motion" ||
    s.category === "statement" ||
    (!s.category && s.sectionType === "OS"),
);
const clarifications = sections.filter((s) => s.category === "clarification");
const bills = sections.filter(
  (s) => s.sectionType === "BI" || s.sectionType === "BP",
);
const questions = sections.filter(
  (s) =>
    ["OA", "WA", "WANA"].includes(s.sectionType) &&
    !motions.includes(s) &&
    !clarifications.includes(s),
);

const attendancePercent =
  member.attendanceTotal && member.attendanceTotal > 0
    ? Math.round((member.attendancePresent! / member.attendanceTotal) * 100)
    : null;
---

<Layout
  title={member.name}
  description={`Parliamentary activities for ${member.name}`}
>
  <a
    href="/members"
    class="inline-flex items-center font-sans text-sm text-accent hover:text-accent-light no-underline mb-8"
    data-pagefind-ignore
  >
    ← Back to Members
  </a>

  <section
    class="mb-10"
    data-pagefind-body
    data-pagefind-filter="type:member"
    data-pagefind-meta={`id:${member.id}`}
  >
    <div class="flex items-start gap-5 mb-6">
      <Avatar name={member.name} class="w-16 h-16 text-xl" />

      <div class="flex-1">
        <h1
          class="font-display text-display-md text-ink mb-2"
          data-pagefind-weight="10"
        >
          {member.name}
        </h1>

        <div class="flex flex-wrap items-center gap-3 mb-4">
          {
            member.designation && (
              <span
                class="font-sans text-base text-ink-soft"
                data-pagefind-weight="5"
              >
                {member.designation}
              </span>
            )
          }
          {
            member.constituency && (
              <span data-pagefind-weight="5">
                <Tag color="muted">{member.constituency}</Tag>
              </span>
            )
          }
        </div>
      </div>
    </div>

    <!-- Everything below excluded from search indexing -->
    <div data-pagefind-ignore>
      {currentParlStats ? (
        <!-- Combined stats table: labels once, two value rows -->
        <div class="border border-border rounded-lg overflow-hidden mb-8">
          <!-- Column headers -->
          <div class="grid grid-cols-6 gap-0 bg-surface-alt border-b border-border">
            <div class="px-4 py-2.5"></div>
            <div class="px-4 py-2.5 font-sans text-[10px] uppercase tracking-wider text-ink-muted font-semibold">
              Total <br> Involvements
            </div>
            <div class="px-4 py-2.5 font-sans text-[10px] uppercase tracking-wider text-ink-muted font-semibold">
              Questions <br> Asked/Answered
            </div>
            <div class="px-4 py-2.5 font-sans text-[10px] uppercase tracking-wider text-ink-muted font-semibold">
              Motions <br> Spoken On
            </div>
            <div class="px-4 py-2.5 font-sans text-[10px] uppercase tracking-wider text-ink-muted font-semibold">
              Bills <br> Spoken On
            </div>
            <div class="px-4 py-2.5 font-sans text-[10px] uppercase tracking-wider text-ink-muted font-semibold">
              Attendance
            </div>
          </div>
          <!-- Current Parliament row -->
          <div class="grid grid-cols-6 gap-0 border-b border-border bg-amber-50/30">
            <div class="px-4 py-4 flex items-center">
              <span class="font-sans text-xs uppercase tracking-wide text-accent font-semibold">
                Current Parliament
              </span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{currentParlStats.involvements}</span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{currentParlStats.questions}</span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{currentParlStats.motions}</span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{currentParlStats.bills}</span>
            </div>
            <div class="px-4 py-4">
              {currentParlStats.attendanceTotal > 0 ? (
                <span
                  class:list={[
                    "font-display text-xl",
                    Math.round((currentParlStats.attendancePresent / currentParlStats.attendanceTotal) * 100) >= 80
                      ? "text-status-passed"
                      : Math.round((currentParlStats.attendancePresent / currentParlStats.attendanceTotal) * 100) >= 50
                        ? "text-status-reading"
                        : "text-red-600",
                  ]}
                >
                  {Math.round((currentParlStats.attendancePresent / currentParlStats.attendanceTotal) * 100)}%
                </span>
              ) : (
                <span class="font-sans text-sm text-ink-muted">—</span>
              )}
            </div>
          </div>
          <!-- Overall row -->
          <div class="grid grid-cols-6 gap-0">
            <div class="px-4 py-4 flex items-center">
              <span class="font-sans text-xs uppercase tracking-wide text-ink-muted font-semibold">
                Overall
              </span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{sections.length}</span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{questions.length}</span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{motions.length}</span>
            </div>
            <div class="px-4 py-4">
              <span class="font-display text-xl text-ink">{bills.length}</span>
            </div>
            <div class="px-4 py-4">
              {attendancePercent !== null ? (
                <span
                  class:list={[
                    "font-display text-xl",
                    attendancePercent >= 80
                      ? "text-status-passed"
                      : attendancePercent >= 50
                        ? "text-status-reading"
                        : "text-red-600",
                  ]}
                >
                  {attendancePercent}%
                </span>
              ) : (
                <span class="font-sans text-sm text-ink-muted">—</span>
              )}
            </div>
          </div>
        </div>
      ) : (
        <!-- Single stats row for members not in current parliament -->
        <div
          class="grid grid-cols-2 md:grid-cols-5 gap-4 py-6 border-y border-border mb-8"
        >
          <div>
            <div class="font-display text-2xl text-ink">{sections.length}</div>
            <div class="font-sans text-xs uppercase tracking-wide text-ink-muted">
              Total <br> Involvements
            </div>
          </div>
          <div>
            <div class="font-display text-2xl text-ink">{questions.length}</div>
            <div class="font-sans text-xs uppercase tracking-wide text-ink-muted">
              Questions <br> Asked/Answered
            </div>
          </div>
          <div>
            <div class="font-display text-2xl text-ink">{motions.length}</div>
            <div class="font-sans text-xs uppercase tracking-wide text-ink-muted">
              Motions <br> Spoken On
            </div>
          </div>
          <div>
            <div class="font-display text-2xl text-ink">{bills.length}</div>
            <div class="font-sans text-xs uppercase tracking-wide text-ink-muted">
              Bills <br> Spoken On
            </div>
          </div>
          {
            attendancePercent !== null && (
              <div>
                <div
                  class:list={[
                    "font-display text-2xl",
                    attendancePercent >= 80
                      ? "text-status-passed"
                      : attendancePercent >= 50
                        ? "text-status-reading"
                        : "text-red-600",
                  ]}
                >
                  {attendancePercent}%
                </div>
                <div class="font-sans text-xs uppercase tracking-wide text-ink-muted">
                  Attendance
                </div>
              </div>
            )
          }
        </div>
      )}

      <!-- Member Summary -->
      <div class="mb-8">
        <AISummaryCard
          title="Summary of Recent Topics"
          content={member.summary}
          fallbackMessage="Summary of recent topics has not been generated yet."
        />
      </div>

      <!-- Attendance Components (both shown for comparison) -->
      {
        attendance.length > 0 &&
          member.attendancePresent != null &&
          member.attendanceTotal != null && (
            <>
              <div class="mb-8">
                <AttendanceDotGrid
                  attendance={attendance}
                  attendancePresent={member.attendancePresent}
                  attendanceTotal={member.attendanceTotal}
                />
              </div>
            </>
          )
      }
    </div><!-- end data-pagefind-ignore -->
  </section>

  <!-- Unified search across all sections -->
  <div class="mb-8" data-pagefind-ignore data-member-name={member.name}>
    <div class="relative">
      <svg
        class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-ink/40 pointer-events-none"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input
        type="text"
        id="member-search-input"
        class="w-full rounded-lg border border-border bg-surface px-4 py-2.5 pl-10 pr-10 font-ui text-sm text-ink placeholder:text-ink/40 focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent/20 transition-colors"
        placeholder="Search this member's parliamentary activity..."
        autocomplete="off"
        spellcheck="false"
      />
      <button
        type="button"
        id="member-search-clear"
        class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-ink/40 hover:text-ink transition-colors hidden"
        aria-label="Clear search"
      >
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <p
      id="member-search-status"
      class="mt-2 font-sans text-sm text-ink-muted hidden"
    >
    </p>
  </div>

  <!-- Motions Section -->
  {
    (
      <section class="mb-10" data-pagefind-ignore>
        <h2 class="font-display text-xl text-ink mb-4">
          Motions{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({motions.length})
          </span>
        </h2>

        <div id="motions-list" class="flex flex-col border-t border-border">
          {motions.map((section) => (
            <div class="motion-item">
              <QuestionCard section={section} showSpeakers={false} />
            </div>
          ))}
        </div>
        <Pagination
          containerId="motions-list"
          itemSelector=".motion-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  <!-- Bills Section -->
  {
    (
      <section class="mb-10" data-pagefind-ignore>
        <h2 class="font-display text-xl text-ink mb-4">
          Bills{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({bills.length})
          </span>
        </h2>

        <div id="bills-list" class="flex flex-col border-t border-border">
          {bills.map((section) => (
            <a
              href={`/bills/${slugify((section as any).billTitle || section.sectionTitle, (section as any).billId)}`}
              class="bill-item group block p-5 border-b border-border transition-colors hover:bg-warm no-underline"
              data-search-id={(section as any).billId || section.id}
            >
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <Tag color={section.sectionType === "BI" ? "muted" : "accent"}>
                  {section.sectionType === "BI" ? "1st Reading" : "2nd Reading"}
                </Tag>
                {section.ministry && (
                  <Tag color="green">{section.ministry}</Tag>
                )}
                {section.sittingDate && (
                  <span class="font-sans text-xs text-ink-muted">
                    {new Date(section.sittingDate).toLocaleDateString("en-SG", {
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                    })}
                  </span>
                )}
              </div>
              <h3 class="font-display text-lg text-ink leading-snug line-clamp-2 group-hover:text-accent transition-colors">
                {section.sectionTitle}
              </h3>
            </a>
          ))}
        </div>
        <Pagination
          containerId="bills-list"
          itemSelector=".bill-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  <!-- Clarifications Section -->
  {
    clarifications.length > 0 && (
      <section class="mb-10" data-pagefind-ignore>
        <h2 class="font-display text-xl text-ink mb-4">
          Clarifications{" "}
          <span class="font-sans text-sm text-ink-muted font-normal">
            ({clarifications.length})
          </span>
        </h2>

        <div
          id="clarifications-list"
          class="flex flex-col border-t border-border"
        >
          {clarifications.map((section) => (
            <div class="clarification-item">
              <QuestionCard section={section} showSpeakers={false} />
            </div>
          ))}
        </div>
        <Pagination
          containerId="clarifications-list"
          itemSelector=".clarification-item"
          itemsPerPage={10}
        />
      </section>
    )
  }

  <!-- Questions Section -->
  <section data-pagefind-ignore>
    <h2 class="font-display text-xl text-ink mb-4">
      Parliamentary Questions <span
        class="font-sans text-sm text-ink-muted font-normal"
        >({questions.length})</span
      >
    </h2>
    {
          <div id="questions-list" class="flex flex-col border-t border-border">
            {questions.map((section) => (
              <div class="question-item">
                <QuestionCard section={section} showSpeakers={false} />
              </div>
            ))}
          </div>
          <Pagination
            containerId="questions-list"
            itemSelector=".question-item"
            itemsPerPage={10}
          />
    }
  </section>
  <script>
    interface PagefindResult {
      id: string;
      data: () => Promise<{
        meta?: { id?: string };
        url: string;
        excerpt: string;
      }>;
    }

    interface PagefindSearch {
      results: PagefindResult[];
    }

    interface Pagefind {
      search: (
        query: string,
        options?: { filters?: Record<string, string> },
      ) => Promise<PagefindSearch>;
    }

    let pagefind: Pagefind | null = null;

    async function loadPagefind(): Promise<Pagefind | null> {
      if (pagefind) return pagefind;
      try {
        const base = import.meta.env.BASE_URL || "/";
        const pagefindPath = `${base}pagefind/pagefind.js`.replace(/\/+/g, "/");
        pagefind = (await import(/* @vite-ignore */ pagefindPath)) as Pagefind;
        return pagefind;
      } catch {
        return null;
      }
    }

    function initMemberSearch() {
      const wrapper = document.querySelector(
        "[data-member-name]",
      ) as HTMLElement;
      if (!wrapper) return;
      const memberName = wrapper.getAttribute("data-member-name")!;

      const input = document.getElementById(
        "member-search-input",
      ) as HTMLInputElement;
      const clearBtn = document.getElementById(
        "member-search-clear",
      ) as HTMLButtonElement;
      const status = document.getElementById(
        "member-search-status",
      ) as HTMLElement;
      if (!input) return;
      if (input.hasAttribute("data-search-initialized")) return;
      input.setAttribute("data-search-initialized", "true");

      const sectionConfigs = [
        { id: "motions-list", selector: ".motion-item" },
        { id: "bills-list", selector: ".bill-item" },
        { id: "clarifications-list", selector: ".clarification-item" },
        { id: "questions-list", selector: ".question-item" },
      ]
        .map((s) => {
          const container = document.getElementById(s.id);
          if (!container) return null;
          const sectionEl = container.closest("section");
          const items = Array.from(
            container.querySelectorAll(s.selector),
          ) as HTMLElement[];
          return { container, sectionEl, items };
        })
        .filter(Boolean) as {
        container: HTMLElement;
        sectionEl: Element | null;
        items: HTMLElement[];
      }[];

      function getItemId(item: HTMLElement): string | null {
        return item.getAttribute("data-search-id") || item.querySelector("[data-search-id]")?.getAttribute("data-search-id") || null;
      }

      let debounceTimer: ReturnType<typeof setTimeout>;
      let searchSeq = 0;

      function updateSections(
        matchingIds: Set<string> | null,
        lowerQuery: string,
      ) {
        let totalMatches = 0;
        for (const sec of sectionConfigs) {
          let sectionMatches = 0;
          for (const item of sec.items) {
            let isMatch: boolean;
            if (matchingIds !== null) {
              const id = getItemId(item);
              isMatch = id !== null && matchingIds.has(id);
            } else {
              const text = item.textContent?.toLowerCase() || "";
              isMatch = text.includes(lowerQuery);
            }
            if (isMatch) {
              item.style.display = "";
              item.removeAttribute("data-search-hidden");
              sectionMatches++;
            } else {
              item.style.display = "none";
              item.setAttribute("data-search-hidden", "true");
            }
          }
          if (sec.sectionEl) {
            (sec.sectionEl as HTMLElement).style.display =
              sectionMatches === 0 ? "none" : "";
          }
          totalMatches += sectionMatches;
          sec.container.dispatchEvent(
            new CustomEvent("search-updated", {
              detail: { matchCount: sectionMatches, reordered: false },
            }),
          );
        }
        status.textContent = `Found ${totalMatches} result${totalMatches !== 1 ? "s" : ""}`;
        status.classList.remove("hidden");
      }

      async function performSearch(query: string) {
        const seq = ++searchSeq;
        const lowerQuery = query.toLowerCase().trim();

        if (!lowerQuery) {
          for (const sec of sectionConfigs) {
            if (sec.sectionEl)
              (sec.sectionEl as HTMLElement).style.display = "";
            for (const item of sec.items) {
              item.style.display = "";
              item.removeAttribute("data-search-hidden");
            }
            sec.container.dispatchEvent(
              new CustomEvent("search-cleared", {
                detail: { reordered: false },
              }),
            );
          }
          status.classList.add("hidden");
          clearBtn.classList.add("hidden");
          return;
        }

        clearBtn.classList.remove("hidden");

        // Try Pagefind first
        const pf = await loadPagefind();
        if (seq !== searchSeq) return;

        if (pf) {
          const results = await pf.search(query, {
            filters: { speaker: memberName },
          });
          if (seq !== searchSeq) return;

          // Fetch all fragments in parallel
          const allFragments = await Promise.all(
            results.results.map((r) => r.data()),
          );
          if (seq !== searchSeq) return;

          const orderedIds: string[] = [];
          for (const data of allFragments) {
            if (data.meta?.id) {
              orderedIds.push(data.meta.id);
            }
          }
          const matchingIds = new Set<string>(orderedIds);

          updateSections(matchingIds, lowerQuery);
          return;
        }

        // Fallback: text matching
        updateSections(null, lowerQuery);
      }

      input.addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => performSearch(input.value), 100);
      });

      clearBtn.addEventListener("click", () => {
        input.value = "";
        performSearch("");
        input.focus();
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && input.value) {
          input.value = "";
          performSearch("");
        }
      });

      // Preload pagefind on focus
      input.addEventListener(
        "focus",
        () => {
          loadPagefind();
        },
        { once: true },
      );
    }

    initMemberSearch();
    document.addEventListener("astro:after-swap", initMemberSearch);
  </script>
</Layout>
