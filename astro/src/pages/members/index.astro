---
import Layout from "../../layouts/Layout.astro";
import SectionLabel from "../../components/SectionLabel.astro";
import MemberCard from "../../components/MemberCard.astro";
import Avatar from "../../components/Avatar.astro";
import SearchFilter from "../../components/SearchFilter.astro";
import {
  getMembersWithInfo,
  getMemberCount,
  getAllMembersWithInfo,
} from "../../lib/db";
import { slugify } from "../../lib/slugify";

const currentMembers = getMembersWithInfo();
const allMembers = getAllMembersWithInfo();
const currentMemberIds = new Set(currentMembers.map((m) => m.id));
const formerMembers = allMembers.filter((m) => !currentMemberIds.has(m.id));
const STAGGER_LIMIT = 12;
const totalCount = getMemberCount();
---

<Layout title="MPs" description="Members of Parliament">
  <h1 class="font-display text-display-lg text-ink mb-4">
    Members of Parliament
  </h1>

  <div
    class="font-body text-base text-ink-soft leading-relaxed mb-8 space-y-3 text-pretty"
  >
    <p>
      Here, you can find the individual profiles of Members of Parliament (MPs)
      along with their records of their involvements in Parliament. The
      individual pages of each MP also have AI-generated summaries of their 20
      latest contributions in Parliament.
    </p>
    <p>
      In Singapore, there are three types of MPs: elected, non-constituency, and
      nominated.
    </p>

    <p>
      <strong class="text-ink">Elected MPs</strong> are voted in by members of the
      different constituencies in Singapore. These consistutencies are geographical
      divisions of Singapore drawn before every election by the Elections Department,
      which is under the Prime Minister's Office. Some of these MPs will be appointed
      to positions in the Government and become office holders. The rest of the elected
      MPs are known as backbenchers. Office holders include Ministers, Senior Ministers
      of State, Ministers of State, and Senior Parliamentary Secretaries.
    </p>
    <p>
      <strong class="text-ink">Non-Constituency Members (NCMPs)</strong> are declared
      as MPs from opposition parties who were not elected in the General Election,
      but received the highest percentage of votes amongst the unelected candidates
      from the opposition parties.
    </p>

    <p>
      <strong class="text-ink">Nominated Members (NMPs)</strong> are appointed by
      the President of Singapore and are meant to provide non-partisan views in Parliament.
    </p>

    <p>
      Don't know who your MP is? Enter your postal code in the map below to find
      out!
    </p>
    <div class="w-full overflow-hidden">
      <iframe
        title="2025 General Election Results Map"
        src="https://elections.data.gov.sg/en/map?isScrollable=true&primaryColor=%236253E8&view=Winning%20margin&lang=en&year=2025&constituenciesView=all"
        class="h-[980px] w-full border-none sm:h-[740px] md:h-[620px]"></iframe>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row gap-4 mb-6">
    <div class="flex-1">
      <SearchFilter
        containerId="members-list"
        itemSelector=".member-item"
        contentType="member"
        placeholder="Search MPs (past and present) by name, constituency, or designation..."
      />
    </div>
    <div class="flex items-start gap-3">
      <select
        id="member-sort"
        class="rounded-lg border border-border bg-surface px-3 py-2.5 font-ui text-sm text-ink focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent/20 transition-colors cursor-pointer"
      >
        <option value="name-asc">Name (Aâ€“Z)</option>
        <option value="involvements-desc">Most involvements</option>
        <option value="attendance-desc">Highest attendance</option>
      </select>
    </div>
  </div>

  <h1 class="font-display text-lg text-ink mb-2 flex items-center gap-2">
    Current MPs
    <span
      class="font-sans text-xs font-normal text-ink-muted bg-surface-alt px-2 py-0.5 rounded-full"
    >
      {currentMembers.length}
    </span>
  </h1>

  <div id="members-list" class="grid gap-4 sm:grid-cols-2">
    {
      currentMembers.length === 0 ? (
        <p class="col-span-full py-12 text-center font-body text-ink-muted">
          No members found
        </p>
      ) : (
        currentMembers.map((member, i) => {
          const isStaggered = i < STAGGER_LIMIT;
          const attendancePercent =
            member.attendanceTotal && member.attendanceTotal > 0
              ? Math.round(
                  (member.attendancePresent! / member.attendanceTotal) * 100,
                )
              : 0;
          return (
            <div
              class={`member-item h-full${isStaggered ? " animate-fade-up" : ""}`}
              style={
                isStaggered ? `animation-delay: ${0.1 + i * 0.03}s` : undefined
              }
              data-name={member.name}
              data-involvements={member.sectionCount || 0}
              data-attendance={attendancePercent}
              data-parliament="current"
            >
              <MemberCard member={member} />
            </div>
          );
        })
      )
    }

    {/* Former members: hidden by default, shown only when matching search */}
    {
      formerMembers.map((member) => (
        <div
          class="member-item member-former h-full"
          style="display: none;"
          data-name={member.name}
          data-involvements={member.sectionCount || 0}
          data-attendance={0}
          data-parliament="former"
        >
          <a
            href={`/members/${slugify(member.name, member.id)}`}
            class="group flex h-full gap-4 items-start p-4 bg-surface border border-border rounded-md transition-colors hover:bg-warm hover:border-ink-muted cursor-pointer opacity-75"
            data-search-id={member.id}
          >
            <Avatar name={member.name} />
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-0.5">
                <span class="font-display text-base text-ink font-medium group-hover:text-accent transition-colors">
                  {member.name}
                </span>
                <span class="font-sans text-[10px] uppercase tracking-wider text-ink-muted bg-surface-alt px-1.5 py-0.5 rounded">
                  Former
                </span>
              </div>
              <div class="font-sans text-xs text-accent font-medium">
                {member.sectionCount !== undefined &&
                  member.sectionCount > 0 && (
                    <span>{member.sectionCount} involvements</span>
                  )}
              </div>
            </div>
          </a>
        </div>
      ))
    }
  </div>

  <script>
    function initMemberPage() {
      const select = document.getElementById(
        "member-sort",
      ) as HTMLSelectElement | null;
      const container = document.getElementById("members-list");

      if (
        select &&
        container &&
        !select.hasAttribute("data-sort-initialized")
      ) {
        select.setAttribute("data-sort-initialized", "true");

        select.addEventListener("change", () => {
          const [key, dir] = select.value.split("-");
          // Only sort visible current parliament items
          const items = Array.from(
            container.querySelectorAll(
              '.member-item[data-parliament="current"]',
            ),
          ) as HTMLElement[];

          items.sort((a, b) => {
            if (key === "name") {
              const aVal = (a.dataset.name || "").toLowerCase();
              const bVal = (b.dataset.name || "").toLowerCase();
              return dir === "asc"
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
            }
            const aVal = parseInt(a.dataset[key] || "0", 10);
            const bVal = parseInt(b.dataset[key] || "0", 10);
            return dir === "asc" ? aVal - bVal : bVal - aVal;
          });

          const fragment = document.createDocumentFragment();
          items.forEach((item) => fragment.appendChild(item));
          // Insert before the first former member (or at end)
          const firstFormer = container.querySelector(".member-former");
          if (firstFormer) {
            container.insertBefore(fragment, firstFormer);
          } else {
            container.appendChild(fragment);
          }
        });
      }

      // Re-hide former members when search is cleared
      if (container && !container.hasAttribute("data-former-initialized")) {
        container.setAttribute("data-former-initialized", "true");

        container.addEventListener("search-cleared", () => {
          container.querySelectorAll(".member-former").forEach((el) => {
            (el as HTMLElement).style.display = "none";
          });
        });
      }
    }

    initMemberPage();
    document.addEventListener("astro:after-swap", initMemberPage);
  </script>
</Layout>
