---
import Layout from "../../layouts/Layout.astro";
import SectionLabel from "../../components/SectionLabel.astro";
import MemberCard from "../../components/MemberCard.astro";
import SearchFilter from "../../components/SearchFilter.astro";
import { getMembersWithInfo, getMemberCount } from "../../lib/db";

const members = getMembersWithInfo();
const STAGGER_LIMIT = 12;
const totalCount = getMemberCount();
---

<Layout title="MPs" description="Members of Parliament">
  <h1 class="font-display text-display-lg text-ink mb-4">
    Members of Parliament
  </h1>

  <div
    class="font-body text-base text-ink-soft leading-relaxed mb-8 space-y-3 text-pretty"
  >
    <p>
      Here, you can find the individual profiles of Members of Parliament (MPs)
      along with their records of their involvements in Parliament. The
      individual pages of each MP also have AI-generated summaries of their 20
      latest contributions in Parliament.
    </p>
    <p>
      In Singapore, there are three types of MPs: elected, non-constituency, and
      nominated.
    </p>

    <p>
      <strong class="text-ink">Elected MPs</strong> are voted in by members of the
      different constituencies in Singapore. These consistutencies are geographical
      divisions of Singapore drawn before every election by the Elections Department,
      which is under the Prime Minister's Office. Some of these MPs will be appointed
      to positions in the Government and become office holders. The rest of the elected
      MPs are known as backbenchers. Office holders include Ministers, Senior Ministers
      of State, Ministers of State, and Senior Parliamentary Secretaries.
    </p>
    <p>
      <strong class="text-ink">Non-Constituency Members (NCMPs)</strong> are declared
      as MPs from opposition parties who were not elected in the General Election,
      but received the highest percentage of votes amongst the unelected candidates
      from the opposition parties.
    </p>

    <p>
      <strong class="text-ink">Nominated Members (NMPs)</strong> are appointed by
      the President of Singapore and are meant to provide non-partisan views in Parliament.
    </p>

    <p>
      Don't know who your MP is? Enter your postal code in the map below to find
      out!
    </p>
    <div class="w-full overflow-hidden">
      <iframe
        title="2025 General Election Results Map"
        src="https://elections.data.gov.sg/en/map?isScrollable=true&primaryColor=%236253E8&view=Winning%20margin&lang=en&year=2025&constituenciesView=all"
        class="h-[980px] w-full border-none sm:h-[740px] md:h-[620px]"></iframe>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row gap-4 mb-6">
    <div class="flex-1">
      <SearchFilter
        containerId="members-list"
        itemSelector=".member-item"
        contentType="member"
        placeholder="Search by name, constituency, or designation..."
      />
    </div>
    <div class="flex items-start">
      <select
        id="member-sort"
        class="rounded-lg border border-border bg-surface px-3 py-2.5 font-ui text-sm text-ink focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent/20 transition-colors cursor-pointer"
      >
        <option value="name-asc">Name (Aâ€“Z)</option>
        <option value="involvements-desc">Most involvements</option>
        <option value="attendance-desc">Highest attendance</option>
      </select>
    </div>
  </div>

  <p
    class="font-sans text-sm text-ink-muted mb-6"
    data-search-count="members-list"
  >
    Showing {members.length} of {totalCount} members
  </p>

  <div id="members-list" class="grid gap-4 sm:grid-cols-2">
    {
      members.length === 0 ? (
        <p class="col-span-full py-12 text-center font-body text-ink-muted">
          No members found
        </p>
      ) : (
        members.map((member, i) => {
          const isStaggered = i < STAGGER_LIMIT;
          const attendancePercent =
            member.attendanceTotal && member.attendanceTotal > 0
              ? Math.round(
                  (member.attendancePresent! / member.attendanceTotal) * 100,
                )
              : 0;
          return (
            <div
              class={`member-item h-full${isStaggered ? " animate-fade-up" : ""}`}
              style={
                isStaggered ? `animation-delay: ${0.1 + i * 0.03}s` : undefined
              }
              data-name={member.name}
              data-involvements={member.sectionCount || 0}
              data-attendance={attendancePercent}
            >
              <MemberCard member={member} />
            </div>
          );
        })
      )
    }
  </div>

  <script>
    function initMemberSort() {
      const select = document.getElementById(
        "member-sort",
      ) as HTMLSelectElement | null;
      const container = document.getElementById("members-list");
      if (!select || !container) return;
      if (select.hasAttribute("data-sort-initialized")) return;
      select.setAttribute("data-sort-initialized", "true");

      select.addEventListener("change", () => {
        const [key, dir] = select.value.split("-");
        const items = Array.from(
          container.querySelectorAll(".member-item"),
        ) as HTMLElement[];

        items.sort((a, b) => {
          if (key === "name") {
            const aVal = (a.dataset.name || "").toLowerCase();
            const bVal = (b.dataset.name || "").toLowerCase();
            return dir === "asc"
              ? aVal.localeCompare(bVal)
              : bVal.localeCompare(aVal);
          }
          const aVal = parseInt(a.dataset[key] || "0", 10);
          const bVal = parseInt(b.dataset[key] || "0", 10);
          return dir === "asc" ? aVal - bVal : bVal - aVal;
        });

        const fragment = document.createDocumentFragment();
        items.forEach((item) => fragment.appendChild(item));
        container.appendChild(fragment);
      });
    }

    initMemberSort();
    document.addEventListener("astro:after-swap", initMemberSort);
  </script>
</Layout>
