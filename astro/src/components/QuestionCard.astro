---
import type { Section } from "../lib/db";
import TypeBadge from "./TypeBadge.astro";
import Tag from "./Tag.astro";
import { slugify } from "../lib/slugify";

interface Props {
  section: Section;
  showSpeakers?: boolean;
}

const { section, showSpeakers = true } = Astro.props;

const categoryLabels: Record<string, string> = {
  motion: "Motion",
  adjournment_motion: "Adjournment Motion",
  clarification: "Clarification",
  statement: "Statement",
};

const formattedDate = section.sittingDate
  ? new Date(section.sittingDate).toLocaleDateString("en-SG", {
      year: "numeric",
      month: "short",
      day: "numeric",
    })
  : null;

const snippet =
  section.contentPlain?.substring(0, 150) +
  (section.contentPlain && section.contentPlain.length > 150 ? "..." : "");

// Route based on category
const routePrefix =
  section.category === "motion" || section.category === "adjournment_motion"
    ? "/motions"
    : section.category === "clarification"
      ? "/clarifications"
      : "/questions";
---

<a
  href={`${routePrefix}/${slugify(section.sectionTitle, section.id)}`}
  class="group block p-5 border-b border-border transition-colors hover:bg-warm cursor-pointer"
  data-search-id={section.id}
>
  <div class="flex flex-wrap items-center gap-2 mb-2">
    {
      section.category && categoryLabels[section.category] ? (
        <Tag color={section.category === "clarification" ? "amber" : "indigo"}>
          {categoryLabels[section.category]}
        </Tag>
      ) : (
        <TypeBadge type={section.sectionType} />
      )
    }
    {section.ministry && <Tag color="green">{section.ministry}</Tag>}
    {
      formattedDate && (
        <span class="font-sans text-xs text-ink-muted">{formattedDate}</span>
      )
    }
  </div>

  <h3
    class="font-display text-lg text-ink leading-snug mb-2 group-hover:text-accent transition-colors line-clamp-2"
  >
    {section.sectionTitle}
  </h3>

  {
    showSpeakers && section.speakers && section.speakers.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-2">
        {section.speakers.slice(0, 3).map((speaker) => (
          <span class="font-sans text-xs text-accent">{speaker.name}</span>
        ))}
        {section.speakers.length > 3 && (
          <span class="font-sans text-xs text-ink-muted">
            +{section.speakers.length - 3} more
          </span>
        )}
      </div>
    )
  }
</a>
